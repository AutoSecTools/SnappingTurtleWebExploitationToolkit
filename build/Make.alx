#'Config';
using System;
using System.IO;
using System.Linq;
using System.Diagnostics;

testCmds = [
    '..\\st.py -lfi "http://localhost/test.php" --g theme $lfi',
    '..\\st.py -lfi "http://localhost/test.php" -g {\'theme\':\'$lfi\'}',
    '..\\st.py -lfi "http://localhost/postTest.php" --p theme $lfi',
    '..\\st.py -lfi "http://localhost/postTest.php" -p {\'theme\':\'$lfi\'}',
    '..\\st.py -sqli "http://localhost/insecure/SQL-Injection/sql-injection-get.php" --g email $sqli',
];

Directory.SetCurrentDirectory('..\\src');
args = Environment.GetCommandLineArgs();
print = Console.WriteLine;
clear = Console.Clear;
count = Enumerable.Count;

exec = @(cmd) {
    si = new ProcessStartInfo('cmd', '/c ' + cmd);
    si.UseShellExecute = false;    
    Process.Start(si).WaitForExit();
};

pause = @{
    print('Press any key to continue...');
    Console.ReadKey();
};

exists = File.Exists;
remove = File.Delete;

execPy = @(args) exec(python + ' ' + args);
compile = @(args) exec(compiler + ' ' + args);

deploySt = @{
    src = stPyFile;
    dst = stReleasePyFile;
    print("Copying '{0}' to '{1}'", src, dst);
    File.Copy(src, dst, true);
    File.Delete(src);
};

compileSt = @{
    print('Compiling SnappingTurtle\r\n');
    compile(stFile);
    print("");
    
    if (exists(stPyFile)) {
        deploySt();
    }
};

loop = @(f) {
    while (true) {
        print('Running test');
        
        if (exists(stPyFile)) {
            print("Deleting '{0}'", stPyFile);
            remove(stPyFile);
        }

        compileSt();
        
        if (exists(stReleasePyFile)) {
            print('Compilation successful, running test');
            f();
        } else {
            print('Compilation failed');
        }
        
        pause();
        clear();    
    }
};

printDirections = @{
    print("aphid build.alx [options]\r\n");
    print("Options:\r\n");
    print("  -b     build STWET");
    print("  -t     build and test STWET");
};

if(args.Length < 3) {
    printDirections();    
    ret 2;
}

opt = args[2];
isBuild = opt == '-b';
isTest = opt == '-t';

if (!isBuild && !isTest) {
    print("Invalid opt: {0}", opt);
    ret 3;
}

if (isBuild) {    
    compileSt();    
    print('\r\nDone');
} else {
    if (args.Length < 4) {
        print("Missing test number. Tests:\r\n");
        i = 0;
        for (c in testCmds) print("  {0}: {1}", i++, c);
        
        ret 4;
    }
    
    testIndex = args[3];
    if (testIndex >= (testCmds |> count)) {
        print("Invalid test number: {0}.", testIndex);
        ret 5;
    }
    
    c = testCmds[testIndex];
    
    loop(@{
        print("Running command: {0}", c);
        execPy(c)
    });
}
