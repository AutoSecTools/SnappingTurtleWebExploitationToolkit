import('sys');
from('ast', 'literal_eval');

class CliArgs {
    Mode: null,
    ModeOption: null,
    ModeOption2: null,
    Get: null,
    Post: null,
    File: null,
};

class ParserState {
    Class: 0,
    Url: 1,
    Option: 2,
    OptionValue: 3,
    OptionValue2: 4,
    ModeOption: 5,
    ModeOption2: 6,
    Filename: 7,
    FileData: 8,
};

class ArgOption {
    GetPair: '-g',
    PostPair: '-p',
    Get: '--g',
    Post: '--p',    
    File: '-f',
};

class ClassOption {
    Lfi: 'lfi',
    Sqli: 'sqli',
    Xss: 'xss',
    Shell: 'shell',
    Upload: 'upload',
};

class SqliOption {
    List: 'list',
    Table: 'table',
};

__dict = macro(@(__d) {
    if (__d == null) {
        __d = dict();
    }
    d = __d;
});

parseArgs = @{
    i = 0;
    key = null;
    key2 = null;
    key3 = null;
    state = ParserState.Class;
    obj = CliArgs();
    args = sys.argv @skip(1);
    
    for (x in args) {
        switch (state) {
            ParserState.Class: {
                obj.Mode = x;
                
                switch (x) {
                    ClassOption.Sqli, 
                    ClassOption.Xss: state = ParserState.ModeOption;
                    default: state = ParserState.Url;
                }
            }
            ParserState.ModeOption: {
                obj.ModeOption = x;
                
                if (obj.Mode == ClassOption.Sqli &&
                    obj.ModeOption == SqliOption.Table) {
                    state = ParserState.ModeOption2;
                } else {
                    state = ParserState.Url;
                }
            }
            ParserState.ModeOption2: {
                obj.ModeOption2 = x;
                state = ParserState.Url;
            }
            ParserState.Url: {
                obj.Url = x;
                state = ParserState.Option;
            }
            ParserState.Option: {
                key = x;
                state = ParserState.OptionValue;
            }
            ParserState.OptionValue: {
                switch (key) {
                    ArgOption.Get: {
                        obj.Get = literal_eval(x);
                        state = ParserState.Option;
                    }
                    ArgOption.Post: {
                        obj.Post = literal_eval(x);
                        state = ParserState.Option;
                    }
                    ArgOption.GetPair, ArgOption.PostPair: {
                        key2 = x;
                        state = ParserState.OptionValue2;
                    }
                    ArgOption.File: {
                        key2 = x;
                        state = ParserState.Filename;
                    }
                }
            }
            
            ParserState.OptionValue2: {
                d = null;
                switch (key) {
                    ArgOption.GetPair: __dict(obj.Get);
                    ArgOption.PostPair: __dict(obj.Post);
                }
                d[key2] = x;                
                state = ParserState.Option;
            }     

            ParserState.Filename: {
                key3 = x;
                state = ParserState.FileData;
            }
            
            ParserState.FileData: {
                if (obj.File == null) obj.File = [];
                obj.File.append(HttpFile(key2, key3, x));
                state = ParserState.Option;
            }
            
            default: {
                print('Error parsing argument: %s' % x);
                quit();
            }
        }
        
        i++;
    }
    
    ret obj;    
};

hasArgs = sys.argv |> len @> 1;
args = parseArgs();