from('random', 'choice');

class MultipartFormData {
    dispositionPrefix = 'Content-Disposition: form-data; ',
    typePrefix = 'Content-Type: ',
    
    __init__: @() {
        self.boundary = self.createBoundary();
        self.data = '';        
    },
    
    createBoundary: @()
        '--' + (range(0, 64) 
            @select(@(x) CharRange.alpha() |> choice) 
            @join('')),
            
    getBoundary: @(final = false) self.boundary + (final ? '--' : '') + '\r\n',    
    addBoundary: @(final = false) { self.data += self.getBoundary(final) },
    
    addDisposition: @(name, filename = null) {
        self.data += 
            self.dispositionPrefix + 
            (filename == null ? 
                'name="{}"'.format(name) :
                'name="{}"; filename="{}"'.format(name, filename)) + 
            '\r\n';
    },
        
    addType: @(type) {
        self.data += self.typePrefix + type + '\r\n';
    },
    
    addLine: @(value = null) { self.data += (value != null ? value : '') + '\r\n' },
            
    addData: @(name, data) {
        self.addBoundary();
        self.addDisposition(name);
        self.addLine();
        self.addLine(data);        
    },
    
    addFileData: @(name, filename, type, data) {
        self.addBoundary();
        self.addDisposition(name, filename);
        self.addType(type);
        self.addLine();
        self.addLine(data);
    },
    
    __str__: @() self.data + self.getBoundary(final = true),
};