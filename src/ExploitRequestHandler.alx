from('urlparse', 'urlparse', 'parse_qs');
from('BaseHTTPServer', 'BaseHTTPRequestHandler');
class BaseHTTPRequestHandler ExploitRequestHandler {
    do_GET: @{
        uri = urlparse(self.path);
        query = parse_qs(uri.query);
        file = self.getFile(uri.path);
        
        print('Name: %s' % file);
        print('Referer: %s' % self.getReferer());
        print('IP: {}:{}'.format(self.getIP(), self.getPort()));    
        print('Query: %s' % self.getQuery());
        
        code = uri.query != '' || file != null ? 200 : 404;
        self.send_response(code);
        self.send_header('Content-type', 'text/plain');
        self.send_header('Access-Control-Allow-Origin', '*');
        self.end_headers();                
        self.wfile.write('Hello world');
        self.wfile.close();
    },
    
    getIP: @() self.client_address[0],
    getPort: @() self.client_address[1],
    getUrl: @() urlparse(self.path),
    getQuery: @() self.getUrl().query |> parse_qs,
    
    getReferer: @()
        self.headers.getheaders('referer') 
            @(r) len(r) != 0 ? r[0] : null,
    
    getFile: @(path) {
        if (len(path) == 0) ret null;        
        name = path[__emit('1:')];        
        text = self.server.payloads.get(name);        
        ret text;
    },
};