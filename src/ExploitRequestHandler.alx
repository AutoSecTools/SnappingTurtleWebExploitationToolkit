from('urlparse', 'urlparse', 'parse_qs');
from('BaseHTTPServer', 'BaseHTTPRequestHandler');
class BaseHTTPRequestHandler ExploitRequestHandler {
    do_GET: @{
        uri = urlparse(self.path);
        query = parse_qs(uri.query);
        file = self.getFile(uri.path);
        code = uri.query != '' || file != null ? 200 : 404;
        self.send_response(code);
        self.send_header('Content-type', 'text/plain');
        self.send_header('Access-Control-Allow-Origin', '*');
        self.end_headers();
                
        self.wfile.write('Hello world');
        self.wfile.close();
    },
    
    getReferer: @() self.headers.getheaders('referer'),
    
    getFile: @(path) {
        if (len(path) == 0) {
            ret null;
        }
        
        name = path[__emit('1:')];
        print('Name: %s' % name);
        print('Referer: %s' % self.getReferer());
        print('IP: {}:{}'.format(self.client_address[0], self.client_address[1]));
        
        print(path);
        text = self.server.payloads.get(name);
        
        if (text == null) {
            ret null;
        }
        
        ret 1;
        
        print('File found');        
    },
};