from('random', 'choice', 'randint');

class PhpEmitter {
    var_names: [],
    chr: 'chr',
    min: -2147483648,
    max: 2147483647,
    doc: @(body) '<?php %s ?>' % body,
    stmt: @(exp) exp + ';',

	decl_stmt: @(value) {
        n = self.next_var();
        ret n, self.assign_stmt(n, value);
	},

    assign_stmt: @(var, value) self.stmt('{}={}'.format(var, value)),
	array_access: @(array, dim)  '{}[{}]'.format(array, dim),
    call_stmt: @(target, args) args @self.call(target) |> self.stmt,
    call: @(target, args) '{}({})'.format(target, args),	

    string: @(string, allow_passthru=true, allow_chars=true) {
        funcs = [self.split_string];
        if (allow_chars) funcs.append(self.chars);
        ret choice(funcs)(string);
	},

    echo: @(value) self.stmt('echo %s' % value),

    split_string: @(string) {
        l = len(string);
        if (l < 2) ret self.string(string);
        i = randint(1, l - 1);
        lhs = self.string(string[__emit('0:i')]);
        rhs = self.string(string[__emit('i:l')]);
        ret lhs + '.' + rhs;
	},

    chars: @(str) str @select(self.char) @join('.'),

    char: @(char) {
        c = ord(char);
        n = choice([c, self.widen_byte(c)]);
        ret '{}({})'.format(self.chr, self.number(n));
	},

    number: @(number)
		number
		|> choice([self.emit, self.addition, self.subtraction]),

    addition: @(number) self.bin_op(number, '+', @(x, y) x - y),
    subtraction: @(number) self.bin_op(number, '-', @(x, y) x + y),

    bin_op: @(number, op, func) {
        while(true) {
            x = self.next_int();
            lhs = func(number, x);
            if (self.valid_num(x) && self.valid_num(lhs)) break;
		}
        rhs = self.number(x);
        fmt = op == str(rhs)[__emit(':1')] ? '({}{} {})' : '({}{}{})';
        ret fmt.format(lhs, op, rhs);
	},

    emit: @(value) value,

    next_int: @() 
		choice([0, 8, 16, 32] @select(@(x) randint(self.min >> x, self.max >> x))),

    next_var: @() {
        l = randint(1, 1);
        while (true) {
			v = '$' + (range(0, l) @select(@(x) self.get_rand_char()) |> addAll);
			            
            if (!self.var_names.__contains__(v)) {
                self.var_names.append(v);
                ret v;
			}
		}
	},

    quote: @(string) '"%s"' % self.escape(string),
    get_rand_char: @() self.get_all_chars() |> choice,
    get_all_chars: @() self.get_chars('a') + self.get_chars('A') + '_',
    get_chars: @(start) range(0, 26) @select(@(x) ord(start) + x |> chr) |> addAll,
    escape: @(string) string.replace('\\', '\\\\').replace('"', '\\"'),

    widen_byte: @(number) {
        mask = self.max & ~0xff;
        while (true) {
            x = (self.next_int() & mask) | number;
            if (self.valid_num(x)) ret x;
		}
	},

    valid_num: @(number) self.min <= number && number <= self.max,
};